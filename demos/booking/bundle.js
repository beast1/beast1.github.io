(()=>{"use strict";(()=>{const e=e=>{e.style.display="none"},t=(e,t,o=document)=>{const n=o.querySelector(e);n&&t?n.textContent=t:n&&window.hideNode(n)};window.util={randomInteger:(e,t)=>{const o=e+Math.random()*(t+1-e);return Math.floor(o)},hideNode:e,showNode:e=>{e.style.display="block"},drawTextBlock:t,mapOffsetCheck:(e,t)=>(e<window.data.mapOverlay[t].START?e=window.data.mapOverlay[t].START:e>window.data.mapOverlay[t].END&&(e=window.data.mapOverlay[t].END),e),showUserMessage:(o,n)=>{const i=document.querySelector("#"+o).content.querySelector("."+o).cloneNode(!0),r=i.querySelector(`.${o}__button`);t(`.${o}__message`,n,i),document.querySelector("body").appendChild(i),r&&r.addEventListener("click",(()=>location.reload())),i&&(i.addEventListener("click",(()=>e(i))),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e(i)})))},contains:(e,t)=>{for(let o=0;o<t.length;o++)if(-1===e.indexOf(t[o]))return!1;return!0},findAndRemove:(e,t)=>{e.splice(e.findIndex((e=>e===t)),1)},changeDisabledAttr:(e,t)=>{t?e.setAttribute("disabled","true"):e.removeAttribute("disabled")}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="load",t="upload";window.http=(o,n,i,r,a)=>{const s=new XMLHttpRequest;let d;s.responseType="json",o===e?(d="GET",s.timeout=1e4,s.addEventListener("error",(()=>{r(window.data.messages.http.errDefault)})),s.addEventListener("timeout",(()=>{r(`${window.data.messages.http.timeout.pre} ${s.timeout} ${window.data.messages.http.timeout.post}`)}))):o===t&&(d="POST"),s.addEventListener("load",(()=>{let n;switch(s.status){case window.data.statusDictionary.success:o===e?i(s.response):o===t&&i(window.data.messages.http.success);break;case window.data.statusDictionary.badRequest:n=window.data.messages.http.err400;break;case window.data.statusDictionary.missingAuth:n=window.data.messages.http.err401;break;case window.data.statusDictionary.notFound:n=window.data.messages.http.err404;break;default:n=`${window.data.messages.http.status} ${s.status} ${s.statusText}`}n&&r(`${s.status} ${s.statusText}`)})),s.open(d,n),s.send(a)}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.imgInput={init:(t,o,n)=>{const i=document.querySelector(t),r=document.querySelector(o);i.addEventListener("change",(()=>{if(1===i.files.length){const t=i.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{r.src=e.result})),e.readAsDataURL(t)}}else n&&((t,o)=>{const n=document.querySelector("#preview-img");Array.from(t).forEach((t=>{const i=t.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=n.content.querySelector("img").cloneNode(!0);t.src=e.result,o.appendChild(t)})),e.readAsDataURL(t)}}))})(i.files,r)}))}}})(),(()=>{const e={X:25,Y:70},t=document.querySelector(".map__overlay"),o=document.querySelector(".map__pin--main"),n={y:{START:130,END:630},x:{START:0-o.offsetWidth/2,END:t.offsetWidth-o.offsetWidth/2}},i="Уютный очаг на краю города",r="Теплое место, последнее пристанище расплавленного ума",a=e=>e.features.filter((()=>window.util.randomInteger(0,1))),s=e=>e.photos.filter((()=>window.util.randomInteger(0,1)));window.http("load","https://21.javascript.pages.academy/keksobooking/data",(e=>{var t;window.data.houses=(e=>e.filter((e=>e.offer)))(((t=e).forEach(((e,t)=>{e.frontId=t})),t)),window.controlPin.setActiveState()}),(e=>{window.util.showUserMessage("error",e)})),window.data={mapOverlay:n,pinOffset:e,mockHouses:((t,o)=>{const d=[];for(let o=0;o<8;o++){const c={x:window.util.randomInteger(n.x.START,n.x.END),y:window.util.randomInteger(n.y.START+e.Y,n.y.END)};d.push({author:{avatar:`img/avatars/user0${o+1}.png`},offer:{title:i,address:`${c.x}, ${c.y}`,price:window.util.randomInteger(999,9999),type:t.types[window.util.randomInteger(0,3)],rooms:window.util.randomInteger(1,5),guests:window.util.randomInteger(1,8),checkin:t.checkin[window.util.randomInteger(0,2)],checkout:t.checkin[window.util.randomInteger(0,2)],features:a(t),description:r,photos:s(t)},location:{x:c.x,y:c.y}})}return d})({types:["palace","flat","house","bungalow"],checkin:["12:00","13:00","14:00"],features:["wifi","dishwasher","parking","washer","elevator","conditioner"],photos:["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"]}),messages:{filter:{noResult:"Объявления которые соответствуют заданным фильтрам не были найдены"},http:{success:"Ваша заявка успешно отправлена",errDefault:"Произошла ошибка соединения",err400:"Неверный запрос",err401:"Пользователь не авторизован",err404:"Ничего не найдено",status:"Статус ответа:",timeout:{pre:"Запрос не успел выполниться за",post:"мс"}}},statusDictionary:{success:200,badRequest:400,missingAuth:401,notFound:404}}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.card=(()=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=t.querySelector(".popup__close"),n=document.querySelector(".map__filters-container"),i=t.querySelector(".popup__features"),r=i.querySelector(".popup__feature").cloneNode(!0),a=t.querySelector(".popup__photos"),s=a.querySelector(".popup__photo").cloneNode(!0),d=()=>{window.pin.removeActiveStyles(),window.card.clear()},c=e=>{e.preventDefault(),d()},l=e=>{e.preventDefault(),"Escape"===e.key&&d()};return{draw:d=>{window.util.drawTextBlock(".popup__title",d.offer.title,t),window.util.drawTextBlock(".popup__text--address",d.offer.address,t),window.util.drawTextBlock(".popup__text--price",d.offer.price+"₽/ночь",t),window.util.drawTextBlock(".popup__type",e[d.offer.type],t),window.util.drawTextBlock(".popup__text--capacity",`${d.offer.rooms} комнаты для ${d.offer.guests} гостей`,t),window.util.drawTextBlock(".popup__text--time",`Заезд после ${d.offer.checkin}, выезд до ${d.offer.checkout}`,t),(e=>{if(e&&i){const t=document.createDocumentFragment();e.forEach((e=>{r.className="popup__feature popup__feature--"+e,t.appendChild(r)})),i.innerHTML="",i.appendChild(t)}else i&&window.util.hideNode(i)})(d.offer.features),window.util.drawTextBlock(".popup__description",d.offer.description,t),(e=>{if(e&&a){const t=document.createDocumentFragment();e.forEach((e=>{s.src=e,t.appendChild(s)})),a.innerHTML="",a.appendChild(t)}else a&&window.util.hideNode(a)})(d.offer.photos),(e=>{const o=t.querySelector(".popup__avatar");e&&o?o.src=e:o&&window.util.hideNode(o)})(d.author.avatar),n.before(t),t.classList.remove("hidden"),o.addEventListener("click",c),document.addEventListener("keydown",l)},clear:()=>{t.classList.add("hidden"),o.removeEventListener("click",c),document.removeEventListener("click",l)}}})()})(),window.pin=(()=>{const e=document.querySelector("#map"),t=document.querySelector("#pin"),o=document.createDocumentFragment(),n=document.querySelector(".map__pins"),i=[],r=()=>{i.forEach((e=>{e.remove()}))},a=()=>{n.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")}))},s=e=>{const t=e.target.offsetParent;t&&t.dataset.frontId&&(a(),t.classList.add("map__pin--active"),window.card.draw(window.data.houses[e.target.offsetParent.dataset.frontId]))},d=e=>{"Enter"===e.key&&e.target.dataset.frontId&&window.card.draw(window.data.houses[e.target.dataset.frontId])};return{draw:e=>{e.forEach((e=>{const n=t.content.querySelector(".map__pin").cloneNode(!0);n.querySelector("img").src=e.author.avatar,n.style=`left: ${e.location.x-window.data.pinOffset.X}px; top: ${e.location.y-window.data.pinOffset.Y}px`,n.attributes.src=e.author.avatar,n.attributes.alt=e.offer.title,n.dataset.frontId=e.frontId,o.appendChild(n),i.push(n)})),n.appendChild(o),n.addEventListener("click",s),n.addEventListener("keydown",d)},clear:r,close:()=>{e.classList.add("map--faded"),r(),window.controlPin.setMapState(!1),n.removeEventListener("click",s),n.removeEventListener("keydown",d)},removeActiveStyles:a}})(),(()=>{const e={maxCount:5,type:"any",price:"any",rooms:"any",guests:"any",features:[]};let t=Object.assign({},e);const o=document.querySelector("#pins-filter"),n=e=>{const n=o.querySelector("#housing-"+e);n.addEventListener("input",window.debounce((o=>{o.preventDefault(),t[e]=n.value,i()})))},i=()=>{let e=window.data.houses;"any"!==t.type&&(e=e.filter((e=>e.offer.type===t.type))),"any"!==t.price&&(e=e.filter((e=>(e=>{let t;return e<1e4?t="low":1e4<=e&&e<5e4?t="middle":5e4<=e&&(t="high"),t})(+e.offer.price)===t.price))),"any"!==t.rooms&&(e=e.filter((e=>+e.offer.rooms==+t.rooms))),"any"!==t.guests&&(e=e.filter((e=>+e.offer.guests==+t.guests))),t.features!==[]&&(e=e.filter((e=>window.util.contains(e.offer.features,t.features)))),0===e.length?window.util.showUserMessage("success",window.data.messages.filter.noResult):(e=e.slice(0,t.maxCount),window.card.clear(),window.pin.clear(),window.pin.draw(e))};n("type"),n("price"),n("rooms"),n("guests"),(()=>{const e=o.querySelector("#housing-features").querySelectorAll('input[name="features"]'),n=e=>{e.preventDefault();const o=e.target.id.replace(/filter-/gi,"");!0===e.target.checked?t.features.push(o):window.util.findAndRemove(t.features,o),i()};e.forEach((e=>{e.addEventListener("input",window.debounce(n))}))})(),window.filter={submit:i,reset:()=>{o.reset(),t=Object.assign({},e)}}})(),(()=>{const e={MIN_NAME_LENGTH:30,MAX_NAME_LENGTH:100,type:[{name:"bungalow",MIN_PRICE:0},{name:"flat",MIN_PRICE:1e3},{name:"house",MIN_PRICE:5e3},{name:"palace",MIN_PRICE:1e4}],rooms:[{roomsCount:1,guestOptions:[{value:1,text:"для 1 гостя"}]},{roomsCount:2,guestOptions:[{value:1,text:"для 1 гостя"},{value:2,text:"для 2 гостей"}]},{roomsCount:3,guestOptions:[{value:1,text:"для 1 гостя"},{value:3,text:"для 3 гостей"},{value:2,text:"для 2 гостей"}]},{roomsCount:100,guestOptions:[{value:1,text:"не для гостей"}]}],minPrice:5e3},t=document.querySelector("#ad-form"),o=document.querySelector("#price"),n=()=>{e.minPrice=5e3,o.placeholder=5e3};window.imgInput.init(".ad-form__field input",".ad-form-header__preview img"),window.imgInput.init(".ad-form__upload input",".ad-form__photo",!0),document.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),t.reset(),n(),window.pin.close(),window.filter.reset(),window.card.clear(),window.controlPin.setAddress()})),window.form={rooms:{initValidation:()=>{const t=document.querySelector("#room_number"),o=document.querySelector("#capacity"),n=document.querySelector("#capacity option"),i=()=>{e.rooms.forEach((e=>{if(e.roomsCount===+t.value){const t=document.createDocumentFragment();e.guestOptions.forEach((e=>{const o=n.cloneNode();o.innerText=e.text,o.value=e.value,t.appendChild(o)})),o.innerHTML="",o.appendChild(t)}}))};t.addEventListener("input",(()=>{i()})),i()}},checkin:{initValidation:()=>{const e=document.querySelector("#timein"),t=document.querySelector("#timeout");e.addEventListener("input",(()=>{t.value=e.value})),t.addEventListener("input",(()=>{e.value=t.value}))}},minPrice:{initValidation:()=>{const t=document.querySelector("#type"),n=()=>{o.value<e.minPrice?o.setCustomValidity(`Минимальная цена выбранного типа апартаментов ${e.minPrice} руб.`):o.setCustomValidity(""),o.reportValidity()};t.addEventListener("input",(t=>{(t=>{e.type.forEach((n=>{n.name===t.target.value&&(e.minPrice=n.MIN_PRICE,o.attributes.min=e.minPrice,o.placeholder=e.minPrice)}))})(t),n()})),o.addEventListener("input",(()=>{n()}))}},title:{initValidation:()=>{const t=document.querySelector("#title");t.addEventListener("input",(()=>{const o=t.value.length;o<e.MIN_NAME_LENGTH?t.setCustomValidity(`Ещё ${e.MIN_NAME_LENGTH-o} симв.`):o>e.MAX_NAME_LENGTH?t.setCustomValidity(`Удалите лишние ${o-e.MAX_NAME_LENGTH} симв.`):t.setCustomValidity(""),t.reportValidity()}))}},initSubmit:()=>{const e=e=>{window.pin.close(),window.card.clear(),window.filter.reset(),n(),window.util.showUserMessage("success",e)},o=e=>{window.util.showUserMessage("error",e)};t.addEventListener("submit",(n=>{n.preventDefault(),window.http("upload"," https://21.javascript.pages.academy/keksobooking",e,o,new FormData(t))}))}}})(),(()=>{const e=/[^-0-9]/gim,t=document.querySelector(".map__pin--main"),o={LEFT:t.style.left,TOP:t.style.top},n=e=>{document.querySelector(".map__filters").querySelectorAll("select, input").forEach((t=>{window.util.changeDisabledAttr(t,!e)}))},i=e=>{const t=document.querySelector(".ad-form");t.querySelectorAll("fieldset").forEach((t=>{window.util.changeDisabledAttr(t,!e)})),e?(t.classList.remove("ad-form--disabled"),window.filter.submit(),window.form.rooms.initValidation(),window.form.minPrice.initValidation(),window.form.title.initValidation(),window.form.checkin.initValidation(),window.form.initSubmit()):(t.classList.add("ad-form--disabled"),t.reset())},r=()=>{const o=document.querySelector("#address"),n=+t.style.left.replace(e,"")+25,i=+t.style.top.replace(e,"")+70;o.value=`${n}, ${i}`},a=e=>{e?(document.querySelector(".map").classList.remove("map--faded"),i(!0),n(!0),window.form.rooms.initValidation()):(i(!1),n(!1),t.addEventListener("mousedown",(e=>{0===e.button&&a(!0)}),{once:!0}),t.addEventListener("keydown",(e=>{"Enter"===e.key&&a(!0)}),{once:!0}),t.style.left=o.LEFT,t.style.top=o.TOP,r())};window.controlPin={init:()=>{window.util.hideNode(t),a(!1),r(),t.addEventListener("mousedown",(e=>{e.preventDefault(),0===e.button&&(e=>{let o={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=o.x-e.clientX,i=o.y-e.clientY;o={x:e.clientX,y:e.clientY},t.style.top=window.util.mapOffsetCheck(t.offsetTop-i,"y")+"px",t.style.left=window.util.mapOffsetCheck(t.offsetLeft-n,"x")+"px"},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",i),r()};document.addEventListener("mousemove",n),document.addEventListener("mouseup",i)})(e)}))},setActiveState:()=>{window.util.showNode(t)},setMapState:a,setAddress:r}})(),window.controlPin.init()})();